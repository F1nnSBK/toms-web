<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <script defer src="https://unpkg.com/alpinejs@3.14.1/dist/cdn.min.js"></script>
</head>
<body>

<div th:fragment="login-form"
     x-data="{
        username: '',
        password: '',
        errorMessage: '',
        showError: false,
        loading: false, // Für Lade-Indikator des Buttons

        // CSRF-Token direkt von Thymeleaf in das JS-Scope von Alpine.js injizieren
        csrfParamName: /*[[${_csrf.parameterName}]]*/ '_csrf',
        csrfToken: /*[[${_csrf.token}]]*/ '',
        csrfHeaderName: /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN',

        // Alpine.js Methode für den Login-Vorgang
        async handleLogin() {
            this.loading = true; // Ladezustand aktivieren
            this.showError = false; // Vorherige Fehlermeldungen ausblenden
            this.errorMessage = ''; // Fehlermeldung leeren

            // FormData verwenden, um die Daten im 'application/x-www-form-urlencoded' Format zu senden
            const formData = new URLSearchParams();
            formData.append('username', this.username);
            formData.append('password', this.password);
            formData.append(this.csrfParamName, this.csrfToken); // CSRF-Token hinzufügen

            try {
                const response = await fetch(/*[[@{/login}]]*/ '/login', { // Dynamische URL per Thymeleaf
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                        // Für Form-Submits ist der CSRF-Token im Body oft ausreichend,
                        // der Header ist eher für andere AJAX-APIs relevant.
                        // Falls es Probleme gibt, könntest du hier [this.csrfHeaderName]: this.csrfToken hinzufügen.
                    },
                    body: formData.toString(),
                    credentials: 'include'
                });

                if (response.ok) { // Status 200-299 (Erfolg)
                    // Login erfolgreich! Formular zurücksetzen, Modal schließen und weiterleiten
                    this.clearForm();
                    this.closeModal(); // Methode zum Schließen des Bootstrap-Modals
                    window.location.href = '/admin'; // Redirect zur Admin-Seite
                } else if (response.status === 401) { // Unauthorized (Login fehlgeschlagen)
                    this.errorMessage = 'Ungültiger Benutzername oder Passwort.';
                    this.showError = true;
                } else {
                    // Andere Fehler (z.B. 500 Internal Server Error)
                    this.errorMessage = 'Ein unerwarteter Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.';
                    this.showError = true;
                }
            } catch (error) {
                console.error('Login-Fehler:', error);
                this.errorMessage = 'Netzwerkfehler oder Server nicht erreichbar.';
                this.showError = true;
            } finally {
                this.loading = false; // Ladezustand deaktivieren
            }
        },

        // Methode zum Zurücksetzen der Formularfelder und Fehlermeldungen
        clearForm() {
            this.username = '';
            this.password = '';
            this.errorMessage = '';
            this.showError = false;
            this.loading = false;
        },

        // Methode zum Schließen des Bootstrap-Modals
        closeModal() {
            const modalElement = document.getElementById('loginModal'); // ID deines Bootstrap-Modals
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }
        }
     }"
     x-init="
        // Optional: Beim Initialisieren des Alpine-Komponenten das Formular leeren
        clearForm();
        // Event-Listener für das Schließen des Modals hinzufügen, um Formular zu leeren
        const modalElement = document.getElementById('loginModal');
        if (modalElement) {
             modalElement.addEventListener('hidden.bs.modal', () => this.clearForm());
        }
     ">

    <div th:if="${param.logout}" class="alert alert-success" role="alert">
        Sie wurden erfolgreich abgemeldet.
    </div>

    <div x-show="showError" x-text="errorMessage" class="alert alert-danger" role="alert">
    </div>

    <form @submit.prevent="handleLogin">
        <div class="mb-3">
            <label for="username" class="form-label">Benutzername:</label>
            <input type="text" class="form-control" id="username" x-model="username" required autofocus>
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Passwort:</label>
            <input type="password" class="form-control" id="password" x-model="password" required>
        </div>
        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary" x-bind:disabled="loading">
                <span x-show="!loading"><i class="fas fa-sign-in-alt me-1"></i> Anmelden</span>
                <span x-show="loading">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Lädt...
                </span>
            </button>
        </div>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    </form>
</div>

</body>
</html>